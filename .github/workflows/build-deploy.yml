name: Build and Deploy

on:
  push:
    branches: [production]

env:
  SERVER_IMAGE_NAME: itsdevin/bow-mark-server
  CLIENT_IMAGE_NAME: itsdevin/bow-mark-client
  CLIENT_CONCRETE_IMAGE_NAME: itsdevin/bow-mark-concrete-client

jobs:
  build-server:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASS }}

      - uses: docker/build-push-action@v6
        with:
          context: ./server
          push: true
          tags: |
            ${{ env.SERVER_IMAGE_NAME }}:latest
            ${{ env.SERVER_IMAGE_NAME }}:${{ github.sha }}
          cache-from: type=gha,scope=server
          cache-to: type=gha,mode=max,scope=server

  build-client-paving:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Prepare paving env
        run: |
          echo "SSR_API_URL=https://paving.bowmark.ca/graphql" >> ./client/.env.local
          echo "NEXT_PUBLIC_APP_NAME=Paving" >> ./client/.env.local
          echo "NEXT_PUBLIC_API_URL=https://paving.bowmark.ca/graphql" >> ./client/.env.local
          echo "NEXT_PUBLIC_WS_API_URL=wss://paving.bowmark.ca/graphql" >> ./client/.env.local
          echo "NEXT_PUBLIC_ANALYTICS_ID=G-ZJFP23D24Y" >> ./client/.env.local
          echo "NEXT_PUBLIC_GOOGLE_MAPS_API_KEY=AIzaSyAQHGi8N0C03ZpAWz6XhVTZI1xtxg31ag8" >> ./client/.env.local
          rm ./client/public/manifest.json
          cp ./client/public/manifest-paving.json ./client/public/manifest.json

      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASS }}

      - uses: docker/build-push-action@v6
        with:
          context: ./client
          push: true
          tags: |
            ${{ env.CLIENT_IMAGE_NAME }}:latest
            ${{ env.CLIENT_IMAGE_NAME }}:${{ github.sha }}
          cache-from: type=gha,scope=client-paving
          cache-to: type=gha,mode=max,scope=client-paving

  build-client-concrete:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Prepare concrete env
        run: |
          echo "SSR_API_URL=https://concrete.bowmark.ca/graphql" >> ./client/.env.local
          echo "NEXT_PUBLIC_APP_NAME=Concrete" >> ./client/.env.local
          echo "NEXT_PUBLIC_API_URL=https://concrete.bowmark.ca/graphql" >> ./client/.env.local
          echo "NEXT_PUBLIC_WS_API_URL=wss://concrete.bowmark.ca/graphql" >> ./client/.env.local
          echo "NEXT_PUBLIC_ANALYTICS_ID=G-8798JH035P" >> ./client/.env.local
          echo "NEXT_PUBLIC_GOOGLE_MAPS_API_KEY=AIzaSyAQHGi8N0C03ZpAWz6XhVTZI1xtxg31ag8" >> ./client/.env.local
          rm ./client/public/manifest.json
          cp ./client/public/manifest-concrete.json ./client/public/manifest.json

      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASS }}

      - uses: docker/build-push-action@v6
        with:
          context: ./client
          push: true
          tags: |
            ${{ env.CLIENT_CONCRETE_IMAGE_NAME }}:latest
            ${{ env.CLIENT_CONCRETE_IMAGE_NAME }}:${{ github.sha }}
          cache-from: type=gha,scope=client-concrete
          cache-to: type=gha,mode=max,scope=client-concrete

  deploy:
    needs: [build-server, build-client-paving, build-client-concrete]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update && sudo apt-get -y install gettext-base

          curl -sSL "https://dl.k8s.io/release/$(curl -sSL https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl" -o kubectl
          chmod +x kubectl

          curl -sSL https://github.com/digitalocean/doctl/releases/download/v1.114.0/doctl-1.114.0-linux-amd64.tar.gz \
            | tar -xz
          chmod +x doctl

      - name: Deploy to DigitalOcean
        env:
          DO_API_TOKEN: ${{ secrets.DO_API_TOKEN }}
          DO_CLUSTER: ${{ secrets.DO_CLUSTER }}
          COMMIT_SHA1: ${{ github.sha }}
        run: sh ./scripts/ci-deploy.sh
